# AdBlock Locus 1.4.0
# -----------------------------------------------------------------------------------
# This macro was modified by RJJIII from the following macro by JamesD and siria:
# http://kmeleonbrowser.org/forum/read.php?9,135175
# It is distributed as part of the AdBlock Locus package.
#
# UTF-8  K-Meleon Macros (http://kmeleon.sourceforge.net/wiki/index.php?id=MacroLanguage2)
#
# ---------- Adblockplugin.kmm / button for the BAB / AdBlock Locus component -------
#
# KM forum : 		http://kmeleonbrowser.org/forum/read.php?19,156032
# Website:			https://rjjiii.github.io/K-Meleon/AdBlockLocus/
# Dependencies :  	K-Meleon/kplugins/adblock.dll
# Preferences : 	Web list URL in "kmeleon.plugins.adblock.subscriptions" 
#   (plugin)          "kmeleon.plugins.adblock.logging", "kmeleon.plugins.adblock.disabled",
# Preferences       : "kmeleon.plugins.adblock.rules.auto", "kmeleon.plugins.adblock.log.auto", 
#   (macro)           "kmeleon.plugins.adblock.rules.days", "kmeleon.plugins.adblock.log.days",
#                     "kmeleon.plugins.adblock.rules.next", "kmeleon.plugins.adblock.log.next",
#                     "kmeleon.plugins.adblock.rules.cleared", "kmeleon.plugins.adblock.log.cleared"
# Files             : adblock.txt, adblock.log, adblockmacro.log  ( in the profile )
# -----------------------------------------------------------------------------------

_Adblockplugin_disable {
menuchecked= getpref( BOOL, "kmeleon.plugins.adblock.disabled") ;
macroinfo= _("Disable the plugin, checked or enable the plugin, un-checked.");
macros("_Adblockplugin_toggle");
}

_Adblockplugin_subscriptions {
macroinfo=_("View the list of subscriptions.");
$_Adblockplugin_sources  = getpref( STRING, "kmeleon.plugins.adblock.subscriptions") ; 
$_Adblockplugin_sources = gsub( "|", "\n\n", $_Adblockplugin_sources );
alert($_Adblockplugin_sources, _("Subscriptions"), INFO);
}

_Adblockplugin_logging {
menuchecked= getpref( BOOL, "kmeleon.plugins.adblock.logging");
macroinfo= _("Toggle logging. Checked is active.");
togglepref( BOOL, "kmeleon.plugins.adblock.logging");
$__adblogging = getpref(BOOL, "kmeleon.plugins.adblock.logging");
$__adblogging ? $__adblogging = _("TRUE") : $__adblogging = _("FALSE");
$_adblockmacro_text = date( "%Y-%m-%d %H:%M" )." >> "._("Logging set to ").$__adblogging._(" by user.");
appendfile($_BABmacro_path, "\n".$_adblockmacro_text);
}

_Adblockplugin_FileNotFound{
alert(sub("%s",$acfg_File,_("The file %s could not be found.")),_(Adblock),EXCLAIM);
}

_Adblockplugin_rules {
macroinfo=_("Open the rules in a text editor.");
menugrayed = getpref(BOOL, "kmeleon.plugins.adblock.rules.cleared");
$__path=getfolder(ProfileFolder)."\\".$ARG.".txt";
$__data=readfile($__path);
if ($__data=="") {&_Adblockplugin_FileNotFoundRules;
 } else {
 $ext="txt"; &getSecureExtensionHandler;
 exec(sub("%1",$__path,$cmdline));
 }
}

#I want to create a similar placeholder text file where I can make a message including, how the BAB works, copy/paste, nuke, etc.
_Adblockplugin_user_rules {
macroinfo=_("Open the rules in a text editor.");
menugrayed = getpref(BOOL, "kmeleon.plugins.adblock.rules.cleared");
$__path=getfolder(ProfileFolder)."\\".$ARG.".txt";
$__data=readfile($__path);
if ($__data=="") {&_Adblockplugin_FileNotFoundUserRules;
 } else {
 $ext="txt"; &getSecureExtensionHandler;
 exec(sub("%1",$__path,$cmdline));
 }
}

_Adblockplugin_FileNotFoundUserRules{
$_file=getfolder(ProfileFolder)."\\adblock_user.txt";
$_x=appendfile($_file, "! AdBlock Locus custom rules subscription");
$__path=getfolder(ProfileFolder)."\\".$ARG.".txt";
$__data=readfile($__path);
if ($__data=="") {&_Adblockplugin_FileNotFound;
 } else {
 $ext="txt"; &getSecureExtensionHandler;
 exec(sub("%1",$__path,$cmdline));
 }
}



_Adblockplugin_logs {
macroinfo=_("Open the log file (adblock.log) in a text editor.");
menugrayed = getpref(BOOL, "kmeleon.plugins.adblock.log.cleared"); 
$__path=getfolder(ProfileFolder)."\\".$ARG.".log";
$__data=readfile($__path);
if ($__data=="") {&_Adblockplugin_FileNotFound;
 } else {
 $ext="log"; &getExtensionHandler;
 exec(sub("%1",$__path,$cmdline));
 }
}

_Adblockplugin_clear_rules {
macroinfo=_("Delete the current rules (adblock.txt).");
menugrayed = getpref(BOOL, "kmeleon.plugins.adblock.rules.cleared");  
# Delete prefs first to avoid duplication bug
delpref( "kmeleon.plugins.adblock.subscriptions" );
$__path=getfolder(ProfileFolder)."\\adblock.txt" ;
$__return = deletefile($__path);
if ($__return) {
  logmsg(_("Adblock clear rules succeded. code = ").$__return, warning);
  setpref(BOOL, "kmeleon.plugins.adblock.rules.cleared", true); 
  $_adblockmacro_text = date( "%Y-%m-%d %H:%M" )." >> "._("The rules file, adblock.txt, was deleted by user.");
  appendfile($_BABmacro_path, "\n".$_adblockmacro_text);
  macros("_Adblockplugin_toolbar_set");
  } else {
  logmsg(_("Adblock clear rules failed. code = ").$__return, error);
  }  
}

_Adblockplugin_clear_log {
macroinfo=_("Delete the current log file (adblock.log).");
menugrayed = getpref(BOOL, "kmeleon.plugins.adblock.log.cleared");  
$__path=getfolder(ProfileFolder)."\\adblock.log" ;
$__return = deletefile($__path);
if ($__return) {
  logmsg(_("Adblock clear log succeded. code = ").$__return , warning);
  setpref(BOOL, "kmeleon.plugins.adblock.log.cleared", true);
  $_adblockmacro_text = date( "%Y-%m-%d %H:%M" )." >> "._("The log file, adblock.log, was deleted by user.");
  appendfile($_BABmacro_path, "\n".$_adblockmacro_text);
  } else {
  logmsg(_("Adblock clear log failed. code = ").$__return , error);
  }  
}

_Adblockplugin_Aclear_rules {
menuchecked= getpref( BOOL, "kmeleon.plugins.adblock.rules.auto") ;
macroinfo= _("Toggle automatic update of rules from subscriptions.");
togglepref( BOOL, "kmeleon.plugins.adblock.rules.auto");
$__abauto = getpref(BOOL, "kmeleon.plugins.adblock.rules.auto");
$__abauto ? $__abauto =_("ON") : $__abauto =_("OFF") ; 
logmsg(_("Adblock plugin automatic value for rules set to ").$__abauto.".", warning);
statusbar(_("Adblock rules file automatic deletion set to")." >> ".$__abauto." <<.");
}    

_Adblockplugin_Aclear_rules_I {
macroinfo= _("Set the interval for automatic updates.");
$_Adblockplugin_rule_days=getpref(INT, "kmeleon.plugins.adblock.rules.days");
$__abtype = _("rules") ; $__abtypeL = "rules" ;
macros("_Adblockplugin_Aclear_interval");
}

_Adblockplugin_Aclear_log {
menuchecked= getpref( BOOL, "kmeleon.plugins.adblock.log.auto") ;
macroinfo= _("Toggle automatic deletion of logs.");
togglepref( BOOL, "kmeleon.plugins.adblock.log.auto");
$__abauto = getpref(BOOL, "kmeleon.plugins.adblock.log.auto");
$__abauto ? $__abauto =_("ON") : $__abauto =_("OFF") ; 
logmsg(_("Adblock plugin automatic value for log set to ").$__abauto.".", warning);
statusbar(_("Adblock log file automatic deletion set to")." >> ".$__abauto." <<.");
}

_Adblockplugin_Aclear_log_I {
macroinfo= _("Set the interval for the automatic deletion logs.");
$_Adblockplugin_log_days=getpref(INT, "kmeleon.plugins.adblock.log.days");
$__abtype = _("log");  $__abtypeL = "log" ; 
macros("_Adblockplugin_Aclear_interval");
}

_Adblockplugin_Aclear_interval {
if ( $__abtypeL == "rules" ) {
   $__abint = $_Adblockplugin_rule_days; }else{ $__abint = $_Adblockplugin_log_days; }
$__abintxt1 = _("The measure of time used for\nautomatic actions is one day.\n\nThe value must be at least 1.") ;
$__abintxt2 = _("The current value for deleting \n").$__abtype._(" is\t").$__abint.".";
$__abintxt3 = _("Do you wish to change the current value?");  
$__abcf = confirm( $__abintxt1."\n".$__abintxt2."\n\n".$__abintxt3 , _("Adblock ").$__abtype._(" days verification.") ,YESNO, QUESTION );
if ($__abcf == "YES") { macros("_Adblockplugin_Aclear_int_chg") ;
  }else{ $__abp = $__abint;   macros("_Adblockplugin_Aclear_InvSet"); }
}

_Adblockplugin_Aclear_int_chg {
$__abp = prompt( _("Enter number of days between deletions."), _("Adblock ").$__abtype._(" days selection.") );
$__abp > 0 ? macros("_Adblockplugin_Aclear_verify") : macros("_Adblockplugin_Aclear_OutRange");
}

_Adblockplugin_Aclear_OutRange {
alert(_("The value is out of range. \nIt must be greater than zero"), _("Adblock interval"), EXCLAIM);
macros("_Adblockplugin_Aclear_int_chg");
}

_Adblockplugin_Aclear_verify {  # ask whether to use proposed value
$__abintxt2 = _("The proposed value for deleting \n").$__abtype._(" is\t").$__abp._(" days.");
$__abintxt3 = _("Do you wish to use the proposed value?");  
$__abcf = confirm( $__abintxt1."\n".$__abintxt2."\n\n".$__abintxt3 , _("Adblock ").$__abtype._(" new days verification.") ,YESNO, QUESTION );
$__abcf == "YES" ? &_Adblockplugin_Aclear_InvSet : &_Adblockplugin_Aclear_retryexit ; 
}

_Adblockplugin_Aclear_InvSet {
# $UNIXTIME = time(); 86400 = 1 day
$__abnext = ($__abp * 86400) + time() ;
setpref( INT, "kmeleon.plugins.adblock.".$__abtypeL.".next", $__abnext);
$__abint == $__abp ? 0 : setpref( INT, "kmeleon.plugins.adblock.".$__abtypeL.".days", $__abp );
statusbar(_("The pref ")."'kmeleon.plugins.adblock.".$__abtypeL.".next'"._(" set with days = ").$__abp.".");
logmsg(_("The pref ")."'kmeleon.plugins.adblock.".$__abtypeL.".next'"._(" set with days = ").$__abp.".", warning);
$_adblockmacro_text = date( "%Y-%m-%d %H:%M" )." >> "._("The pref ")."'kmeleon.plugins.adblock.".$__abtypeL.".next'"._(" set with days = ").$__abp.".";
appendfile($_BABmacro_path, "\n".$_adblockmacro_text);
macros("_Adblockplugin_BuildMenuAs");
}

_Adblockplugin_Aclear_retryexit {
$__sbrty = confirm( _("Do you wish to retry setting \n the days value or \ncancel this operation?") , _("Adblock ").$__abtype._(" new days entry."), RETRYCANCEL , QUESTION );
$__sbrty == "RETRY" ? &_Adblockplugin_Aclear_int_chg :0;
}

_Adblockplugin_macro_log {
macroinfo=_("View the macro's log file.");
$__path=getfolder(ProfileFolder)."\\".$ARG.".log";
$__data=readfile($__path);
if ($__data=="") {&_Adblockplugin_FileNotFound;
 } else {
 $ext="log"; &getExtensionHandler;
 exec(sub("%1",$__path,$cmdline));
 }
}

_Adblockplugin_DayCheck {  ## DayCheck happens OnQuit.  Logmsg() items are lost
$_adblockmacro_text = "";  ## set macrotext value to empty -  global over both rules and log
## if rules have been cleared and offline then insert dummy rules
$__path=getfolder(ProfileFolder)."\\adblock.txt";
if ( getpref(BOOL, "kmeleon.plugins.adblock.rules.cleared") ) {
   if ( getpref(BOOL, "kmeleon.general.offline") ) {  ## OFFLINE
      $__return = writefile($__path, "[BASIC ADBLOCK]\n!dummy for offline hold"); 
      if ($__return) {
         $_adblockmacro_text = $_adblockmacro_text ."\n". date( "%Y-%m-%d %H:%M" )." >> "._("Adblock.txt - dummy data for offline.");
      } else {
         $_adblockmacro_text = $_adblockmacro_text ."\n". date( "%Y-%m-%d %H:%M" )." >> "._("Adblock.txt - dummy data for offline failed. code = ").$__return;
      }
      ## if rules are cleared and online, check for dummy and clear if found
   } else {  ## ONLINE
      if (fileexists($__path)) {
         $__return = deletefile($__path); 
         if ($__return) {
           $_adblockmacro_text = $_adblockmacro_text ."\n". date( "%Y-%m-%d %H:%M" )." >> "._("Adblock.txt - removed dummy data for offline.");
           } else {
           $_adblockmacro_text = $_adblockmacro_text ."\n". date( "%Y-%m-%d %H:%M" )." >> "._("Adblock.txt - removed dummy data for offline failed. code = ").$__return;
          }
      }
   }
}
getpref( BOOL, "kmeleon.general.offline") ? &_Adblockplugin_DayCheck3 : &_Adblockplugin_DayCheck2 ;   
}

_Adblockplugin_DayCheck2 {
if ((getpref(BOOL,"kmeleon.plugins.adblock.rules.auto")) and ( time() > getpref(INT,"kmeleon.plugins.adblock.rules.next"))) {
   $__path=getfolder(ProfileFolder)."\\adblock.txt";
   ## remove existing adblock.txt file
   if (fileexists($__path)) {
     $__return = deletefile($__path);
     if ($__return) {
       $_adblockmacro_text = $_adblockmacro_text ."\n". date( "%Y-%m-%d %H:%M" )." >> "._("Adblock.txt file deleted automaticly.");
       } else {
       $_adblockmacro_text = $_adblockmacro_text ."\n". date( "%Y-%m-%d %H:%M" )." >> "._("Adblock clear rules (adblock.txt) failed. code = ").$__return;
       }
     }
     ## increment the rules.next by days
     $__abp = getpref(INT, "kmeleon.plugins.adblock.rules.days");
     $__abnext = ($__abp * 86400) + time() ;
     setpref(INT, "kmeleon.plugins.adblock.rules.next", $__abnext); 
     $_adblockmacro_text = $_adblockmacro_text ."\n". date( "%Y-%m-%d %H:%M" )." >> "._("Adblock next rules delete was set to ").$__abnext." for ". date( "%Y-%m-%d %H:%M",$__abnext );
}
if ((getpref(BOOL,"kmeleon.plugins.adblock.log.auto")) and ( time() > getpref(INT,"kmeleon.plugins.adblock.log.next"))) {
   $__path=getfolder(ProfileFolder)."\\adblock.log";
   ## remove existing adblock.log file
   if (fileexists($__path)) {
     $__return = deletefile($__path);
     if ($__return) {
       $_adblockmacro_text = $_adblockmacro_text ."\n". date( "%Y-%m-%d %H:%M" )." >> "._("Adblock.log file deleted automaticly.");
       } else {
       $_adblockmacro_text = $_adblockmacro_text ."\n". date( "%Y-%m-%d %H:%M" )." >> "._("Adblock clear log (adblock.log) failed. code = ").$__return;
       }
     }
     ## increment the log.next by days
     $__abp = getpref(INT, "kmeleon.plugins.adblock.log.days");
     $__abnext = ($__abp * 86400) + time() ;
     setpref(INT, "kmeleon.plugins.adblock.log.next", $__abnext); 
     $_adblockmacro_text = $_adblockmacro_text ."\n". date( "%Y-%m-%d %H:%M" )." >> "._("Adblock next log delete was set to ").$__abnext." for ". date( "%Y-%m-%d %H:%M",$__abnext );
}
macros("_Adblockplugin_DayCheck3") ;
}

_Adblockplugin_DayCheck3 {
$_BABmacro_path = getfolder(ProfileFolder)."\\adblockmacro.log";
length($_adblockmacro_text) > 1 ? appendfile($_BABmacro_path, $_adblockmacro_text) : 0; ## a single file operation for daycheck
}

_Adblockplugin_QV {
macroinfo=_("Display current settings.");
$__adbQrunning = getpref(BOOL, "kmeleon.plugins.adblock.disabled");
$__adbQrunning ? $__adbQrunning = _("TRUE") : $__adbQrunning = _("FALSE");
$__adbQlogauto = getpref(BOOL, "kmeleon.plugins.adblock.log.auto");
$__adbQlogauto ? $__adbQlogauto = _("TRUE") : $__adbQlogauto = _("FALSE");
$__adbQlogclear = getpref(BOOL, "kmeleon.plugins.adblock.log.cleared");
$__adbQlogclear ? $__adbQlogclear = _("TRUE") : $__adbQlogclear = _("FALSE");
$__adbQloginterval = getpref(INT, "kmeleon.plugins.adblock.log.days");
$__adbQlognext = getpref(INT, "kmeleon.plugins.adblock.log.next");
$__adbQlogging = getpref(BOOL, "kmeleon.plugins.adblock.logging");
$__adbQlogging ? $__adbQlogging = _("TRUE") : $__adbQlogging = _("FALSE");
$__adbQruleauto = getpref(BOOL, "kmeleon.plugins.adblock.rules.auto");
$__adbQruleauto ? $__adbQruleauto = _("TRUE") : $__adbQruleauto = _("FALSE");
$__adbQruleclear = getpref(BOOL, "kmeleon.plugins.adblock.rules.cleared");
$__adbQruleclear ? $__adbQruleclear = _("TRUE") : $__adbQruleclear = _("FALSE");
$__adbQruleinterval = getpref(INT, "kmeleon.plugins.adblock.rules.days");
$__adbQrulenext = getpref(INT, "kmeleon.plugins.adblock.rules.next");
$__adbQtxt = fileexists(getfolder(ProfileFolder))."\\adblock.txt";
$__adbQtxt ? $__adbQtxt = _("AVAILABLE") : $__adbQtxt = _("NOT AVAILABLE");
$__adbQlog = getfolder(ProfileFolder)."\\adblock.log";
$__adbQlog ? $__adbQlog = _("AVAILABLE") : $__adbQlog = _("NOT AVAILABLE");
$__adbQicon = getpref(BOOL, "kmeleon.plugins.adblock.icons.alternate");
$__adbQicon ? $__adbQicon = _("TRUE") : $__adbQicon = _("FALSE"); 
$__adbQtext = _("Plugin disabled is ").$__adbQrunning;
$__adbQtext = $__adbQtext ."\n". _("Logging is ").$__adbQlogging;
$__adbQtext = $__adbQtext ."\n". _("File adblock.txt is ").$__adbQtxt;
$__adbQtext = $__adbQtext ."\n". _("File adblock.log is ").$__adbQlog;
$__adbQtext = $__adbQtext ."\n". _("Displaying alternate icons is ").$__adbQicon;
$__adbQtext = $__adbQtext ."\n\n". _("Automatics");
$__adbQtext = $__adbQtext ."\n". _("Auto delete rules is ").$__adbQruleauto;
$__adbQtext = $__adbQtext ."\n". _("Interval for rules is ").$__adbQruleinterval._(" days.");
$__adbQtext = $__adbQtext ."\n". _("Next date for rules is ").date("%Y-%m-%d %H:%M", $__adbQrulenext);
$__adbQtext = $__adbQtext ."\n". _("Auto delete log is ").$__adbQlogauto;
$__adbQtext = $__adbQtext ."\n". _("Interval for log is ").$__adbQloginterval._(" days.");
$__adbQtext = $__adbQtext ."\n". _("Next date for log is ").date("%Y-%m-%d %H:%M", $__adbQlognext);
alert($__adbQtext, _("Adblock Locus settings"), INFO);
}

_Adblockplugin_ICONS {
menuchecked= getpref(BOOL, "kmeleon.plugins.adblock.icons.alternate" ) ;
macroinfo = _("If checked, green indicates that the adblocker is ON.");
togglepref( BOOL, "kmeleon.plugins.adblock.icons.alternate") ;
$_Adblockplugin_IcoChg = true;
macros("_Adblockplugin_toolbar_set");
}


_Adblockplugin_allowDomain {
macroinfo= _("Add an exception for this domain.");
$_ABL_domain = hostname($URLBAR);  
$_line="\n\n@@||";
$_line=$_line.$_ABL_domain."^\n\n";
$_file=getfolder(ProfileFolder)."\\adblock.txt";
$_x=appendfile($_file, $_line);
$_allowConfirm="An exception was made for " . $_ABL_domain ." \n\nIt will be allowed after you restart K-Meleon.";
$_file2=getfolder(ProfileFolder)."\\adblock_user.txt";
$_x=appendfile($_file2, $_line);
if ($_x==false) alert("AdBlock Locus cannot write to adblock.txt rules.","Error",EXCLAIM);
alert($_allowConfirm);
}

_Adblockplugin_allowAddress {
macroinfo= _("Add an exception for the current contents of the URL bar.");
$_line="\n\n@@";
$_line=$_line.$URLBAR."\n\n";
$_file=getfolder(ProfileFolder)."\\adblock.txt";
$_x=appendfile($_file, $_line);
$_allowConfirm="An exception was made for " . $URLBAR ." \n\nIt will be allowed after you restart K-Meleon.";
$_file2=getfolder(ProfileFolder)."\\adblock_user.txt";
$_x=appendfile($_file2, $_line);
if ($_x==false) alert("AdBlock Locus cannot write to adblock.txt rules.","Error",EXCLAIM);
alert($_allowConfirm);
}



_Adblockplugin_About{
macroinfo= _("Display information, version number, and copyright for AdBlock Locus.");
alert(_("AdBlock Locus enables access to K-Meleon's built-in adblocker. It was created by the community and is not endorsed by K-Meleon or AdBlock Plus. For development information and support visit the K-Meleon forums.

AdBlock Locus has been distributed freely and is provided AS IS, WITHOUT WARRANTY OF ANY KIND. In no event shall the authors be liable for any claim, damage, or other liability.

Special thanks to: Dorian, James D, Siria, Rodocop, and the K-Meleon community.

Version 1.3

Copyright © 2022, all rights reserved."),_("AdBlock Locus 1.0"), INFO);
}

#Setting up subscriptions from menu:
_Adblockplugin_Sub_Core {
macroinfo= _("A lightweight block list for AdBlock Locus. *Recommended Base*");
menuchecked=getpref(BOOL, "kmeleon.plugins.adblock.subs.core");
togglepref(BOOL, "kmeleon.plugins.adblock.subs.core");
&_Adblockplugin_Sub_Set;
}

_Adblockplugin_Sub_Easylist {
macroinfo= _("A popular blocklist often used with AdBlock Plus. A heavier alternative to AdBlock Locus Core.");
menuchecked=getpref(BOOL, "kmeleon.plugins.adblock.subs.easylist");
togglepref(BOOL, "kmeleon.plugins.adblock.subs.easylist");
&_Adblockplugin_Sub_Set;
}

_Adblockplugin_Sub_Sup {
macroinfo= _("Supplemental subscription.");
menuchecked=getpref(BOOL, "kmeleon.plugins.adblock.subs.".$ARG);
togglepref(BOOL, "kmeleon.plugins.adblock.subs.".$ARG);
&_Adblockplugin_Sub_Set;
}

_Adblockplugin_Sub_Custom {
macroinfo= _("Add the URL for an additional subscription.");
menuchecked=getpref(BOOL,"kmeleon.plugins.adblock.subs.customcheck");
$_Adblockplugin_Custom_Input="";
$_Adblockplugin_Custom_Input=$_Adblockplugin_Custom_Input.getpref(STRING,"kmeleon.plugins.adblock.subs.custom");
$_Adblockplugin_Custom_Input=prompt("Copy and paste a subscription URL below.","Custom subscription", $_Adblockplugin_Custom_Input);

if($_Adblockplugin_Custom_Input!="")
{setpref(STRING, "kmeleon.plugins.adblock.subs.custom", $_Adblockplugin_Custom_Input);
&_Adblockplugin_Sub_Custom_Check;
alert(_("Your custom subscription has been updated to:\n\n".$_Adblockplugin_Custom_Input."\n\nSelect Refresh Rules in the AdBlock Locus menu to re-start K-Meleon and use the new blocklist."),_("Custom Subscription"), INFO);
&_Adblockplugin_Sub_Set;
}
else{
&_Adblockplugin_Sub_Custom_Check;
alert(_("No URL was entered. Your custom subscription below was unchanged:\n\n".getpref(STRING, "kmeleon.plugins.adblock.subs.custom")."\n\nTo disable the custom subscription enter a blank space as a new custom subscription."),_("Custom Subscription"), INFO);}
}

_Adblockplugin_Sub_Custom_Check {
$_Adblockplugin_Check=getpref(STRING, "kmeleon.plugins.adblock.subs.custom");
if(length($_Adblockplugin_Check)>7)
{setpref(BOOL,"kmeleon.plugins.adblock.subs.customcheck",true);}
else{
setpref(BOOL,"kmeleon.plugins.adblock.subs.customcheck",false);
}

}


_Adblockplugin_Sub_Set {
macroinfo= _("Set the above subscriptions to download on next refresh.");
$_Adblockplugin_NewSubs="";

if(getpref(BOOL, "kmeleon.plugins.adblock.subs.core"))
{$_Adblockplugin_NewSubs=$_Adblockplugin_NewSubs."https://rjjiii.github.io/K-Meleon/AdBlockLocus/Core.txt|";}

if(getpref(BOOL, "kmeleon.plugins.adblock.subs.easylist"))
{$_Adblockplugin_NewSubs=$_Adblockplugin_NewSubs."https://easylist-downloads.adblockplus.org/easylist_noelemhide.txt|";}

if(getpref(BOOL, "kmeleon.plugins.adblock.subs.fallback"))
{$_Adblockplugin_NewSubs=$_Adblockplugin_NewSubs."https://rjjiii.github.io/K-Meleon/AdBlockLocus/Fallback.txt|";}

if(getpref(BOOL, "kmeleon.plugins.adblock.subs.french"))
{$_Adblockplugin_NewSubs=$_Adblockplugin_NewSubs."https://filters.adtidy.org/extension/ublock/filters/113_optimized.txt|";}

if(getpref(BOOL, "kmeleon.plugins.adblock.subs.spanish"))
{$_Adblockplugin_NewSubs=$_Adblockplugin_NewSubs."https://filters.adtidy.org/extension/ublock/filters/9_optimized.txt|";}

if(getpref(BOOL, "kmeleon.plugins.adblock.subs.german"))
{$_Adblockplugin_NewSubs=$_Adblockplugin_NewSubs."https://filters.adtidy.org/extension/ublock/filters/107_optimized.txt|";}

if(getpref(BOOL, "kmeleon.plugins.adblock.subs.chinese"))
{$_Adblockplugin_NewSubs=$_Adblockplugin_NewSubs."https://filters.adtidy.org/extension/ublock/filters/104_optimized.txt|";}

if(getpref(BOOL, "kmeleon.plugins.adblock.subs.russian"))
{$_Adblockplugin_NewSubs=$_Adblockplugin_NewSubs."https://filters.adtidy.org/extension/ublock/filters/1_optimized.txt|";}

if(getpref(BOOL, "kmeleon.plugins.adblock.subs.cntblock"))
{$_Adblockplugin_NewSubs=$_Adblockplugin_NewSubs."https://easylist-downloads.adblockplus.org/cntblock.txt|";}

if(getpref(BOOL, "kmeleon.plugins.adblock.subs.privacy"))
{$_Adblockplugin_NewSubs=$_Adblockplugin_NewSubs."https://filters.adtidy.org/extension/ublock/filters/118_optimized.txt|";}

if(getpref(BOOL, "kmeleon.plugins.adblock.subs.facebook"))
{$_Adblockplugin_NewSubs=$_Adblockplugin_NewSubs."https://secure.fanboy.co.nz/fanboy-antifacebook.txt|";}

$_Adblockplugin_usersub=getfolder(ProfileFolder)."\\adblock_user.txt";
$_Adblockplugin_usersub="file:///".gsub("\\","/",$_Adblockplugin_usersub);
$_Adblockplugin_NewSubs=$_Adblockplugin_NewSubs.$_Adblockplugin_usersub."|";

$_Adblockplugin_NewSubs=$_Adblockplugin_NewSubs."|".getpref(STRING, "kmeleon.plugins.adblock.subs.custom");

$_Adblockplugin_Alert ="";
$_Adblockplugin_Alert=$_Adblockplugin_NewSubs;
setpref(STRING, "kmeleon.plugins.adblock.subscriptions", $_Adblockplugin_Alert ) ;
setpref(STRING, "kmeleon.plugins.adblock.newsubscriptions", $_Adblockplugin_Alert ) ;
&_Adblockplugin_subscriptions;
}


_Adblockplugin_FileNotFoundRules{
$_file=getfolder(ProfileFolder)."\\adblock.txt";
$_x=appendfile($_file, "! No rules were found. If this is your first time running AdBlock Locus, choose Refresh Rules from the AdBlock Locus menu to download subscriptions and start blocking ads.");
$__path=getfolder(ProfileFolder)."\\".$ARG.".txt";
$__data=readfile($__path);
if ($__data=="") {&_Adblockplugin_FileNotFound;
 } else {
 $ext="txt"; &getSecureExtensionHandler;
 exec(sub("%1",$__path,$cmdline));
 }
}

_Adblockplugin_initial {
# setpref(BOOL, "kmeleon.plugins.adblock.rules.auto", true);
$__abpmacro_path = getfolder(ProfileFolder) . "//adblockmacro.log";
$_Adblockplugin_len = length(getpref( STRING, "kmeleon.plugins.adblock.subscriptions") );
$__abrdays = getpref(INT, "kmeleon.plugins.adblock.rules.days");
if ($__abrdays < 1) {
 setpref(INT, "kmeleon.plugins.adblock.rules.days", 5);
 $_adblockmacro_text = date( "%Y-%m-%d %H:%M" )." >> "._("Adblock rules delete interval was set to "). 5;
 appendfile($__abpmacro_path, "\n".$_adblockmacro_text);
 $__abnext = (5 * 86400) + time() ;
 setpref(INT, "kmeleon.plugins.adblock.rules.next", $__abnext);
 $_adblockmacro_text = date( "%Y-%m-%d %H:%M" )." >> "._("Adblock next rules delete was set to ").$__abnext." for ". date( "%Y-%m-%d %H:%M",$__abnext );
 appendfile($__abpmacro_path, "\n".$_adblockmacro_text);
 }
$__abldays = getpref(INT, "kmeleon.plugins.adblock.log.days");
if ($__abldays < 1) {
 setpref(INT, "kmeleon.plugins.adblock.log.days", 5);
 $_adblockmacro_text = date( "%Y-%m-%d %H:%M" )." >> "._("Adblock log delete interval was set to "). 5;
 appendfile($__abpmacro_path, "\n".$_adblockmacro_text);
 $__abnext = (5 * 86400) + time() ;
 setpref(INT, "kmeleon.plugins.adblock.log.next", $__abnext);
 $_adblockmacro_text = date( "%Y-%m-%d %H:%M" )." >> "._("Adblock next log delete was set to ").$__abnext." for ". date( "%Y-%m-%d %H:%M",$__abnext );
 appendfile($__abpmacro_path, "\n".$_adblockmacro_text);
 }
 
# Workaround for duplication bug
$_AdblockExistingSubsBug_Check=getpref(STRING, "kmeleon.plugins.adblock.newsubscriptions");
if(length($_AdblockExistingSubsBug_Check)>7)
{
$_Adblockplugin_load=getpref(STRING, "kmeleon.plugins.adblock.newsubscriptions");
}
else{
  $_Adblockplugin_usersub=getfolder(ProfileFolder)."\\adblock_user.txt";
  $_Adblockplugin_usersub="file:///".gsub("\\","/",$_Adblockplugin_usersub);
  $_Adblockplugin_load = "https://rjjiii.github.io/K-Meleon/AdBlockLocus/Core.txt";
  $_Adblockplugin_load = $_Adblockplugin_load ."|". "https://rjjiii.github.io/K-Meleon/AdBlockLocus/Fallback.txt" ; 
  $_Adblockplugin_load = $_Adblockplugin_load ."|".   $_Adblockplugin_usersub ; 
  setpref(BOOL, "kmeleon.plugins.adblock.subs.core", true);
  setpref(BOOL, "kmeleon.plugins.adblock.subs.fallback", true);  
}  
  setpref(STRING, "kmeleon.plugins.adblock.subscriptions", $_Adblockplugin_load ) ;
  $_adblockmacro_text = date( "%Y-%m-%d %H:%M" )." >> "._("Adblock subscriptions initial load approved.");
  appendfile($_BABmacro_path, "\n".$_adblockmacro_text);
  
  
$_Adblockplugin_len <3 ? &_Adblockplugin_initial_load : 0 ;
}

_Adblockplugin_initial2 {
$__abrdays = getpref(INT, "kmeleon.plugins.adblock.rules.days");
if ($__abrdays < 1) {
 setpref(INT, "kmeleon.plugins.adblock.rules.days", 5);
 $_adblockmacro_text = date( "%Y-%m-%d %H:%M" )." >> "._("Adblock rules delete interval was set to "). 5;
 appendfile($_BABmacro_path, "\n".$_adblockmacro_text);
 $__abnext = (5 * 86400) + time() ;
 setpref(INT, "kmeleon.plugins.adblock.rules.next", $__abnext);
 $_adblockmacro_text = date( "%Y-%m-%d %H:%M" )." >> "._("Adblock next rules delete was set to ").$__abnext." for ". date( "%Y-%m-%d %H:%M",$__abnext );
 appendfile($_BABmacro_path, "\n".$_adblockmacro_text);
 }
$__abldays = getpref(INT, "kmeleon.plugins.adblock.log.days");
if ($__abldays < 1) {
 setpref(INT, "kmeleon.plugins.adblock.log.days", 5);
 $_adblockmacro_text = date( "%Y-%m-%d %H:%M" )." >> "._("Adblock log delete interval was set to "). 5;
 appendfile($_BABmacro_path, "\n".$_adblockmacro_text);
 $__abnext = (5 * 86400) + time() ;
 setpref(INT, "kmeleon.plugins.adblock.log.next", $__abnext);
 $_adblockmacro_text = date( "%Y-%m-%d %H:%M" )." >> "._("Adblock next log delete was set to ").$__abnext." for ". date( "%Y-%m-%d %H:%M",$__abnext );
 appendfile($_BABmacro_path, "\n".$_adblockmacro_text);
 }
}

_Adblockplugin_initial_load {
  macros("_Adblockplugin_initial2");
  
removebutton("Adblock_plugin", "macros(_Adblockplugin_toggle)" );
# ?? remove or change?
addbutton("Adblock_plugin", "macros(basic_ab_Dummy)", "Adblock Locus", "Adblock Locus is INACTIVE \n no rules");
setcmdicon("macros(basic_ab_Dummy)", "km-ab-dead.ico" );
}

_Adblockplugin_toggle {
togglepref( BOOL, "kmeleon.plugins.adblock.disabled") ;
macros("_Adblockplugin_toolbar_set");
$__adbdisabled = getpref(BOOL, "kmeleon.plugins.adblock.disabled");
$__adbdisabled ? $__adbdisabled = _("DISABLED") : $__adbdisabled = _("ENABLED");
$_adblockmacro_text = date( "%Y-%m-%d %H:%M" )." >> "._("Ad blocking is ").$__adbdisabled._(" by user.");
appendfile($_BABmacro_path, "\n".$_adblockmacro_text);
statusbar(_("Ad blocking is ").$__adbdisabled);
&_ABL_Sync_PrivacyBar;
}

_Adblockplugin_BuildMenu {
if (($VERSION >= 33685507) and (pluginexist(adblock)) ) {  # K-Meleon 75.1 or greater and adblock plugin
    ## DO NOT set rules cleared to false if adblock.txt contains dummy string
	$_BABmacro_path = getfolder(ProfileFolder)."\\adblockmacro.log";
    $_Adblockplugin_IcoChg = false;
    $__path=getfolder(ProfileFolder)."\\adblock.txt";
    if ( readfile($__path) != "[BASIC ADBLOCK]\n!dummy for offline hold" )  {
      setpref(BOOL, "kmeleon.plugins.adblock.rules.cleared", false);
    }
    setpref(BOOL, "kmeleon.plugins.adblock.log.cleared", false); 
    $_adp= "AdBlock Locus";
	setmenu("PrivacySecurity", popup, $_adp, -1);
    setmenu($_adp, macro, "Allow Domain", "_Adblockplugin_allowDomain", 0);
    setmenu($_adp, macro, "Allow Address", "_Adblockplugin_allowAddress", 1);
    setmenu($_adp, macro, "Restart K-Meleon", "_Adblockplugin_restart_sessions", 2);
	setmenu($_adp, separator, 3);
    setmenu($_adp, macro, "About", "_Adblockplugin_About", 4);		
    $_adA= "Advanced";  $_adAm= "Automatic Settings"; $_adSub= "Subscriptions";
    setmenu($_adp, macro, "View Settings", "_Adblockplugin_QV", 5);
    setmenu($_adp, macro, "Custom Rules", "_Adblockplugin_user_rules(adblock_user)", 6);
    setmenu($_adp, macro, "Refresh Rules", "_Adblockplugin_Refresh", 7);		
	setmenu($_adp, popup, $_adA, 8);
	setmenu($_adp, popup, $_adAm, 9);   
	setmenu($_adp, popup, $_adSub, 10);	
    setmenu($_adp, separator, $_adA);    
    setmenu($_adA, macro, "View the Rules", "_Adblockplugin_rules(adblock)", 0);
    setmenu($_adA, macro, "Clear the Rules", "_Adblockplugin_clear_rules", 1);
    setmenu($_adA, macro, "List Subscriptions", "_Adblockplugin_subscriptions", 2);
	setmenu($_adA, separator, 3);
    setmenu($_adA, macro, "Enable Logging", "_Adblockplugin_logging", 4);
    setmenu($_adA, macro, "Clear the Log", "_Adblockplugin_clear_log", 5);
    setmenu($_adA, macro, "View the Log", "_Adblockplugin_logs(adblock)", 6);
	setmenu($_adA, macro, "View the Macro's Log", "_Adblockplugin_macro_log(adblockmacro)", 7);
	setmenu($_adA, separator, 8);
#    setmenu($_adA, macro, "Invert Icons", "_Adblockplugin_ICONS", 9);
    macros("_Adblockplugin_BuildMenuAs");	
    ## create toolbar and set button
    # check icon and set tool tip
    $_adblockmacro_TTip = "Block ads. Right click for more options." ; 
    addtoolbar("AdBlock Locus") ;
    addbutton("AdBlock Locus", "macros(_Adblockplugin_toggle)", "AdBlock Locus", $_adblockmacro_TTip);
    macros("_Adblockplugin_toolbar_set");
    }
}

_Adblockplugin_BuildMenuAs {
#Automatic settings menu
    setmenu($_adAm, macro, "Update Rules", "_Adblockplugin_Aclear_rules", 0);
    setmenu($_adAm, macro, "Set Interval: ".getpref(INT,"kmeleon.plugins.adblock.rules.days")." Days", "_Adblockplugin_Aclear_rules_I", 1);
    setmenu($_adAm, separator, 2);     
    setmenu($_adAm, macro, "Clear Logs", "_Adblockplugin_Aclear_log", 3); 
    setmenu($_adAm, macro, "Set Interval: ".getpref(INT,"kmeleon.plugins.adblock.log.days")." Days", "_Adblockplugin_Aclear_log_I", 4);
# Subscriptions menu
    setmenu($_adSub, macro, "Core", "_Adblockplugin_Sub_Core", 0);		
    setmenu($_adSub, macro, "Easylist (ABP)", "_Adblockplugin_Sub_Easylist", 1);
    setmenu($_adSub, separator, 2);     
	$_adSupp = "Supplemental";
	setmenu($_adSub, popup, $_adSupp, 3);		
    setmenu($_adSub, macro, "Custom", "_Adblockplugin_Sub_Custom", 4);		
# Supplemental subscriptions
    setmenu($_adSupp, macro, "Français", "_Adblockplugin_Sub_Sup(french)", -1);			
    setmenu($_adSupp, macro, "Español", "_Adblockplugin_Sub_Sup(spanish)", -1);			
    setmenu($_adSupp, macro, "Deutsch", "_Adblockplugin_Sub_Sup(german)", -1);			
    setmenu($_adSupp, macro, "Chinese", "_Adblockplugin_Sub_Sup(chinese)", -1);			
    setmenu($_adSupp, macro, "Italiano", "_Adblockplugin_Sub_Sup(italian)", -1);			
    setmenu($_adSupp, macro, "Russian", "_Adblockplugin_Sub_Sup(russian)", -1);			
    setmenu($_adSupp, macro, "- RU AdList: Counters", "_Adblockplugin_Sub_Sup(cntblock)", -1);	
    setmenu($_adSupp, separator, -1);     	
    setmenu($_adSupp, macro, "EasyPrivacy (Optimized)", "_Adblockplugin_Sub_Sup(privacy)", -1);			
    setmenu($_adSupp, macro, "Anti-Facebook", "_Adblockplugin_Sub_Sup(facebook)", -1);			
    setmenu($_adSupp, macro, "JS Fallback", "_Adblockplugin_Sub_Sup(fallback)", -1);			
}

_Adblockplugin_toolbar_set {
$__abptog = getpref( BOOL, "kmeleon.plugins.adblock.disabled");
$_Adblockplugin_rules = getpref(BOOL, "kmeleon.plugins.adblock.rules.cleared");
# Icons are base64 to fit inside macro file.
# Disabled icon:
$_adblockmacro_DIcon = "data:image/png;base64,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"; 
# Enabled icon:
$_adblockmacro_EIcon = "data:image/png;base64,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"; 
# Inactive icon:
$_adblockmacro_XIcon = "data:image/png;base64,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";
# change tool tip if from  _Adblockplugin_ICONS 
if ( $_Adblockplugin_IcoChg ) {
       # check icon and set tool tip
    if (getpref(BOOL, "kmeleon.plugins.adblock.icons.alternate" ) ) {
       $_adblockmacro_TTip = "AdBlock Locus: ON[green] OFF[red]" ; } else {
       $_adblockmacro_TTip = "Block ads. Right click for more options." ;}
   removebutton("AdBlock Locus", "macros(_Adblockplugin_toggle)" );
   addbutton("AdBlock Locus", "macros(_Adblockplugin_toggle)", "AdBlock Locus", $_adblockmacro_TTip);
   $_Adblockplugin_IcoChg = false;
   }
$__abptog==0 ? setcmdicon( "macros(_Adblockplugin_toggle)", $_adblockmacro_EIcon ) : setcmdicon("macros(_Adblockplugin_toggle)", $_adblockmacro_DIcon );
if (getpref(BOOL, "kmeleon.plugins.adblock.rules.cleared")) {
  removebutton("AdBlock Locus", "macros(_Adblockplugin_toggle)" );
  addbutton("AdBlock Locus", "macros(basic_ab_Dummy)", "AdBlock Locus", "Adblock plugin INACTIVE \n no rules");
  }  
  setcmdicon("macros(basic_ab_Dummy)", $_adblockmacro_XIcon );
}



_Adblockplugin_restart_sessions{
macroinfo= _("Restart K-Meleon with current session.");
$sessdef=getpref(BOOL, "kmeleon.plugins.sessions.autoload");
$sesstyp=getpref(STRING , "kmeleon.plugins.sessions.openStart");
$sessprompt=getpref(BOOL, "kmeleon.plugins.sessions.ask_autoload");
setpref(BOOL, "kmeleon.plugins.sessions.autoload", true);
setpref(STRING , "kmeleon.plugins.sessions.openStart", "Previous Session");
setpref(BOOL, "kmeleon.plugins.sessions.ask_autoload", false);
setpref(BOOL, "kmeleon.extensions.restart.autoload", $sessdef);
setpref(STRING , "kmeleon.extensions.restart.openStart", $sesstyp);
setpref(BOOL, "kmeleon.extensions.restart.ask_autoload", $sessprompt);
setpref(BOOL, "kmeleon.extensions.restart", true);
id(ID_APP_RESTART);
}



_Adblockplugin_Refresh{
macroinfo= _("Clear old rules, download new rules, and restart K-Meleon.");
&_Adblockplugin_clear_rules;
$_Adblock_Refresh = confirm( "To refresh adblocking rules, AdBlock Locus needs to restart K-Meleon. Are you ready to restart K-Meleon?" , _("Restart K-Meleon") , YESNO , QUESTION ); 
if ( $_Adblock_Refresh == "YES" ) {
&_Adblockplugin_restart_sessions;
  } 
  
  else {
alert(_("Old adblocking rules have been cleared. New rules will be available the next time you start K-Meleon."), _("Old Rules Cleared") );
}
}



restartcheck{
$restartact=getpref(BOOL, "kmeleon.extensions.restart");
$restactive=("true");
$restartact==$restactive?&restoreuserses:0;
}


restoreuserses{
setpref(BOOL, "kmeleon.extensions.restart", false);
$sessdef=getpref(BOOL, "kmeleon.extensions.restart.autoload");
$sesstyp=getpref(STRING, "kmeleon.extensions.restart.openStart");
$sessprompt=getpref(BOOL, "kmeleon.extensions.restart.ask_autoload");
setpref(BOOL, "kmeleon.plugins.sessions.autoload", $sessdef);
setpref(STRING , "kmeleon.plugins.sessions.openStart", $sesstyp);
setpref(BOOL, "kmeleon.plugins.sessions.ask_autoload", $sessprompt);
}




# Privacy Bar option
# Add the below entry to "toolsbar.cfg" to block ads from the Privacy Bar
#	!Ads{
#	macros(_Adblockplugin_toggle)|&Privacy
#	Block ads with K-Meleon's built-in ad blocker.
#	check.png[0,32,32]
#	}
_ABL_Sync_PrivacyBar{
pluginmsg(toolbars,"CheckButton","&Privacy Bar".",macros(_Adblockplugin_toggle),".(!getpref(BOOL,"kmeleon.plugins.adblock.disabled")?1:0));
}













# -----------------------------------------------------------
$OnQuit=$OnQuit."_Adblockplugin_DayCheck;";
$OnSetup=$OnSetup."_Adblockplugin_initial;";
$OnStartup=$OnStartup."restartcheck;";
$OnInit=$OnInit."_Adblockplugin_BuildMenu;";
$macroModules=$macroModules."Adblockplugin;";
$OnLoad=$OnLoad."_ABL_Sync_PrivacyBar;";